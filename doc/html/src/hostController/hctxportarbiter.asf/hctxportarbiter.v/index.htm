<html>
<head>
<title>hctxportarbiter.v</title>
<link rel="stylesheet" href="./../../../../css/hde.css">
<meta name="Author" content="Steve, Base2Designs">
<meta name="Generator" content="Active-HDL, Version 6.3.1444, Expiration Date: September 30, 2004\n\nCopyright © ALDEC, Inc. All rights reserved.">
</head>
<body>
<pre>
<span id=t_com>//////////////////////////////////////////////////////////////////////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// HCTxPortArbiter</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// This file is part of the usbhostslave opencores effort.</span>
<span id=t_com>//// http://www.opencores.org/cores/????/                         ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// Module Description:                                          ////</span>
<span id=t_com>//// </span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// To Do:                                                       ////</span>
<span id=t_com>//// </span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// Author(s):                                                   ////</span>
<span id=t_com>//// - Steve Fielding, sfielding@base2designs.com                 ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//////////////////////////////////////////////////////////////////////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// Copyright (C) 2004 Steve Fielding and OPENCORES.ORG          ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// This source file may be used and distributed without         ////</span>
<span id=t_com>//// restriction provided that this copyright statement is not    ////</span>
<span id=t_com>//// removed from the file and that any derivative work contains  ////</span>
<span id=t_com>//// the original copyright notice and the associated disclaimer. ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// This source file is free software; you can redistribute it   ////</span>
<span id=t_com>//// and/or modify it under the terms of the GNU Lesser General   ////</span>
<span id=t_com>//// Public License as published by the Free Software Foundation; ////</span>
<span id=t_com>//// either version 2.1 of the License, or (at your option) any   ////</span>
<span id=t_com>//// later version.                                               ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// This source is distributed in the hope that it will be       ////</span>
<span id=t_com>//// useful, but WITHOUT ANY WARRANTY; without even the implied   ////</span>
<span id=t_com>//// warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR      ////</span>
<span id=t_com>//// PURPOSE. See the GNU Lesser General Public License for more  ////</span>
<span id=t_com>//// details.                                                     ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//// You should have received a copy of the GNU Lesser General    ////</span>
<span id=t_com>//// Public License along with this source; if not, download it   ////</span>
<span id=t_com>//// from http://www.opencores.org/lgpl.shtml                     ////</span>
<span id=t_com>////                                                              ////</span>
<span id=t_com>//////////////////////////////////////////////////////////////////////</span>
<span id=t_com>//</span>
<span id=t_com>// $Id: index.htm,v 1.1.1.1 2004-10-11 03:58:45 sfielding Exp $</span>
<span id=t_com>//</span>
<span id=t_com>// CVS Revision History</span>
<span id=t_com>//</span>
<span id=t_com>// $Log: not supported by cvs2svn $</span>
<span id=t_com>//</span>


<span id=t_dir>`timescale</span> <span id=t_cns>1</span><span id=t_idt>ns</span> / <span id=t_cns>1</span><span id=t_idt>ps</span>

<span id=t_kwd>module</span> <span id=t_idt>HCTxPortArbiter</span> (<span id=t_idt>HCTxPortCntl</span>, <span id=t_idt>HCTxPortData</span>, <span id=t_idt>HCTxPortWEnable</span>, <span id=t_idt>SOFCntlCntl</span>, <span id=t_idt>SOFCntlData</span>, <span id=t_idt>SOFCntlGnt</span>, <span id=t_idt>SOFCntlReq</span>, <span id=t_idt>SOFCntlWEn</span>, <span id=t_idt>clk</span>, <span id=t_idt>directCntlCntl</span>, <span id=t_idt>directCntlData</span>, <span id=t_idt>directCntlGnt</span>, <span id=t_idt>directCntlReq</span>, <span id=t_idt>directCntlWEn</span>, <span id=t_idt>rst</span>, <span id=t_idt>sendPacketCntl</span>, <span id=t_idt>sendPacketData</span>, <span id=t_idt>sendPacketGnt</span>, <span id=t_idt>sendPacketReq</span>, <span id=t_idt>sendPacketWEn</span>);
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>SOFCntlCntl</span>;
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>SOFCntlData</span>;
<span id=t_kwd>input</span>   <span id=t_idt>SOFCntlReq</span>;
<span id=t_kwd>input</span>   <span id=t_idt>SOFCntlWEn</span>;
<span id=t_kwd>input</span>   <span id=t_idt>clk</span>;
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>directCntlCntl</span>;
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>directCntlData</span>;
<span id=t_kwd>input</span>   <span id=t_idt>directCntlReq</span>;
<span id=t_kwd>input</span>   <span id=t_idt>directCntlWEn</span>;
<span id=t_kwd>input</span>   <span id=t_idt>rst</span>;
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>sendPacketCntl</span>;
<span id=t_kwd>input</span>   [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>sendPacketData</span>;
<span id=t_kwd>input</span>   <span id=t_idt>sendPacketReq</span>;
<span id=t_kwd>input</span>   <span id=t_idt>sendPacketWEn</span>;
<span id=t_kwd>output</span>  [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>HCTxPortCntl</span>;
<span id=t_kwd>output</span>  [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>HCTxPortData</span>;
<span id=t_kwd>output</span>  <span id=t_idt>HCTxPortWEnable</span>;
<span id=t_kwd>output</span>  <span id=t_idt>SOFCntlGnt</span>;
<span id=t_kwd>output</span>  <span id=t_idt>directCntlGnt</span>;
<span id=t_kwd>output</span>  <span id=t_idt>sendPacketGnt</span>;

<span id=t_kwd>reg</span>     [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>HCTxPortCntl</span>, <span id=t_idt>next_HCTxPortCntl</span>;
<span id=t_kwd>reg</span>     [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>HCTxPortData</span>, <span id=t_idt>next_HCTxPortData</span>;
<span id=t_kwd>reg</span>     <span id=t_idt>HCTxPortWEnable</span>, <span id=t_idt>next_HCTxPortWEnable</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>SOFCntlCntl</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>SOFCntlData</span>;
<span id=t_kwd>reg</span>     <span id=t_idt>SOFCntlGnt</span>, <span id=t_idt>next_SOFCntlGnt</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>SOFCntlReq</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>SOFCntlWEn</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>clk</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>directCntlCntl</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>directCntlData</span>;
<span id=t_kwd>reg</span>     <span id=t_idt>directCntlGnt</span>, <span id=t_idt>next_directCntlGnt</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>directCntlReq</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>directCntlWEn</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>rst</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>sendPacketCntl</span>;
<span id=t_kwd>wire</span>    [<span id=t_cns>7</span>:<span id=t_cns>0</span>] <span id=t_idt>sendPacketData</span>;
<span id=t_kwd>reg</span>     <span id=t_idt>sendPacketGnt</span>, <span id=t_idt>next_sendPacketGnt</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>sendPacketReq</span>;
<span id=t_kwd>wire</span>    <span id=t_idt>sendPacketWEn</span>;


<span id=t_com>// Constants</span>
<span id=t_dir>`define</span> <span id=t_idt>DIRECT_CTRL_MUX</span> <span id=t_cns>2'b10</span>
<span id=t_dir>`define</span> <span id=t_idt>SEND_PACKET_MUX</span> <span id=t_cns>2'b00</span>
<span id=t_dir>`define</span> <span id=t_idt>SOF_CTRL_MUX</span> <span id=t_cns>2'b01</span>
<span id=t_com>// diagram signals declarations</span>
<span id=t_kwd>reg</span>  [<span id=t_cns>1</span>:<span id=t_cns>0</span>]<span id=t_idt>muxCntl</span>, <span id=t_idt>next_muxCntl</span>;

<span id=t_com>// BINARY ENCODED state machine: HCTxArb</span>
<span id=t_com>// State codes definitions:</span>
<span id=t_dir>`define</span> <span id=t_idt>START_HARB</span> <span id=t_cns>3'b000</span>
<span id=t_dir>`define</span> <span id=t_idt>WAIT_REQ</span> <span id=t_cns>3'b001</span>
<span id=t_dir>`define</span> <span id=t_idt>SEND_SOF</span> <span id=t_cns>3'b010</span>
<span id=t_dir>`define</span> <span id=t_idt>SEND_PACKET</span> <span id=t_cns>3'b011</span>
<span id=t_dir>`define</span> <span id=t_idt>DIRECT_CONTROL</span> <span id=t_cns>3'b100</span>

<span id=t_kwd>reg</span> [<span id=t_cns>2</span>:<span id=t_cns>0</span>] <span id=t_idt>CurrState_HCTxArb</span>;
<span id=t_kwd>reg</span> [<span id=t_cns>2</span>:<span id=t_cns>0</span>] <span id=t_idt>NextState_HCTxArb</span>;

<span id=t_com>// Diagram actions (continuous assignments allowed only: assign ...)</span>
<span id=t_com>// SOFController/directContol/sendPacket mux</span>
<span id=t_kwd>always</span> @(<span id=t_idt>muxCntl</span> <span id=t_kwd>or</span> <span id=t_idt>SOFCntlWEn</span> <span id=t_kwd>or</span> <span id=t_idt>SOFCntlData</span> <span id=t_kwd>or</span> <span id=t_idt>SOFCntlCntl</span> <span id=t_kwd>or</span>
        <span id=t_idt>directCntlWEn</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlData</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlCntl</span> <span id=t_kwd>or</span>
                  <span id=t_idt>directCntlWEn</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlData</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlCntl</span> <span id=t_kwd>or</span>
          <span id=t_idt>sendPacketWEn</span> <span id=t_kwd>or</span> <span id=t_idt>sendPacketData</span> <span id=t_kwd>or</span> <span id=t_idt>sendPacketCntl</span>)
<span id=t_kwd>begin</span>
<span id=t_kwd>case</span> (<span id=t_idt>muxCntl</span>)
    `<span id=t_idt>SOF_CTRL_MUX</span> :
    <span id=t_kwd>begin</span>
        <span id=t_idt>HCTxPortWEnable</span> &lt;= <span id=t_idt>SOFCntlWEn</span>;
        <span id=t_idt>HCTxPortData</span> &lt;= <span id=t_idt>SOFCntlData</span>;
        <span id=t_idt>HCTxPortCntl</span> &lt;= <span id=t_idt>SOFCntlCntl</span>;
    <span id=t_kwd>end</span>
    `<span id=t_idt>DIRECT_CTRL_MUX</span> :
    <span id=t_kwd>begin</span>
        <span id=t_idt>HCTxPortWEnable</span> &lt;= <span id=t_idt>directCntlWEn</span>;
        <span id=t_idt>HCTxPortData</span> &lt;= <span id=t_idt>directCntlData</span>;
        <span id=t_idt>HCTxPortCntl</span> &lt;= <span id=t_idt>directCntlCntl</span>;
    <span id=t_kwd>end</span>
    `<span id=t_idt>SEND_PACKET_MUX</span> :
    <span id=t_kwd>begin</span>
        <span id=t_idt>HCTxPortWEnable</span> &lt;= <span id=t_idt>sendPacketWEn</span>;
        <span id=t_idt>HCTxPortData</span> &lt;= <span id=t_idt>sendPacketData</span>;
        <span id=t_idt>HCTxPortCntl</span> &lt;= <span id=t_idt>sendPacketCntl</span>;
    <span id=t_kwd>end</span>
    <span id=t_kwd>default</span> :
    <span id=t_kwd>begin</span>
        <span id=t_idt>HCTxPortWEnable</span> &lt;= <span id=t_cns>1'b0</span>;
        <span id=t_idt>HCTxPortData</span> &lt;= <span id=t_cns>8'h00</span>;
        <span id=t_idt>HCTxPortCntl</span> &lt;= <span id=t_cns>8'h00</span>;
    <span id=t_kwd>end</span>
<span id=t_kwd>endcase</span>
<span id=t_kwd>end</span>


<span id=t_com>//--------------------------------------------------------------------</span>
<span id=t_com>// Machine: HCTxArb</span>
<span id=t_com>//--------------------------------------------------------------------</span>
<span id=t_com>//----------------------------------</span>
<span id=t_com>// NextState logic (combinatorial)</span>
<span id=t_com>//----------------------------------</span>
<span id=t_kwd>always</span> @ (<span id=t_idt>SOFCntlReq</span> <span id=t_kwd>or</span> <span id=t_idt>sendPacketReq</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlReq</span> <span id=t_kwd>or</span> <span id=t_idt>SOFCntlGnt</span> <span id=t_kwd>or</span> <span id=t_idt>muxCntl</span> <span id=t_kwd>or</span> <span id=t_idt>sendPacketGnt</span> <span id=t_kwd>or</span> <span id=t_idt>directCntlGnt</span> <span id=t_kwd>or</span> <span id=t_idt>CurrState_HCTxArb</span>)
<span id=t_kwd>begin</span> : <span id=t_idt>HCTxArb_NextState</span>
  <span id=t_idt>NextState_HCTxArb</span> &lt;= <span id=t_idt>CurrState_HCTxArb</span>;
  <span id=t_com>// Set default values for outputs and signals</span>
  <span id=t_idt>next_SOFCntlGnt</span> &lt;= <span id=t_idt>SOFCntlGnt</span>;
  <span id=t_idt>next_muxCntl</span> &lt;= <span id=t_idt>muxCntl</span>;
  <span id=t_idt>next_sendPacketGnt</span> &lt;= <span id=t_idt>sendPacketGnt</span>;
  <span id=t_idt>next_directCntlGnt</span> &lt;= <span id=t_idt>directCntlGnt</span>;
  <span id=t_kwd>case</span> (<span id=t_idt>CurrState_HCTxArb</span>) <span id=t_com>// synopsys parallel_case full_case</span>
   `<span id=t_idt>START_HARB</span>:
     <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>WAIT_REQ</span>;
   `<span id=t_idt>WAIT_REQ</span>:
     <span id=t_kwd>if</span> (<span id=t_idt>SOFCntlReq</span> == <span id=t_cns>1'b1</span>)  
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>SEND_SOF</span>;
      <span id=t_idt>next_SOFCntlGnt</span> &lt;= <span id=t_cns>1'b1</span>;
      <span id=t_idt>next_muxCntl</span> &lt;= `<span id=t_idt>SOF_CTRL_MUX</span>;
     <span id=t_kwd>end</span>
     <span id=t_kwd>else</span> <span id=t_kwd>if</span> (<span id=t_idt>sendPacketReq</span> == <span id=t_cns>1'b1</span>)  
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>SEND_PACKET</span>;
      <span id=t_idt>next_sendPacketGnt</span> &lt;= <span id=t_cns>1'b1</span>;
      <span id=t_idt>next_muxCntl</span> &lt;= `<span id=t_idt>SEND_PACKET_MUX</span>;
     <span id=t_kwd>end</span>
     <span id=t_kwd>else</span> <span id=t_kwd>if</span> (<span id=t_idt>directCntlReq</span> == <span id=t_cns>1'b1</span>)  
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>DIRECT_CONTROL</span>;
      <span id=t_idt>next_directCntlGnt</span> &lt;= <span id=t_cns>1'b1</span>;
      <span id=t_idt>next_muxCntl</span> &lt;= `<span id=t_idt>DIRECT_CTRL_MUX</span>;
     <span id=t_kwd>end</span>
   `<span id=t_idt>SEND_SOF</span>:
     <span id=t_kwd>if</span> (<span id=t_idt>SOFCntlReq</span> == <span id=t_cns>1'b0</span>)  
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>WAIT_REQ</span>;
      <span id=t_idt>next_SOFCntlGnt</span> &lt;= <span id=t_cns>1'b0</span>;
     <span id=t_kwd>end</span>
   `<span id=t_idt>SEND_PACKET</span>:
     <span id=t_kwd>if</span> (<span id=t_idt>sendPacketReq</span> == <span id=t_cns>1'b0</span>) 
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>WAIT_REQ</span>;
      <span id=t_idt>next_sendPacketGnt</span> &lt;= <span id=t_cns>1'b0</span>;
     <span id=t_kwd>end</span>
   `<span id=t_idt>DIRECT_CONTROL</span>:
     <span id=t_kwd>if</span> (<span id=t_idt>directCntlReq</span> == <span id=t_cns>1'b0</span>) 
     <span id=t_kwd>begin</span>
      <span id=t_idt>NextState_HCTxArb</span> &lt;= `<span id=t_idt>WAIT_REQ</span>;
      <span id=t_idt>next_directCntlGnt</span> &lt;= <span id=t_cns>1'b0</span>;
     <span id=t_kwd>end</span>
  <span id=t_kwd>endcase</span>
<span id=t_kwd>end</span>

<span id=t_com>//----------------------------------</span>
<span id=t_com>// Current State Logic (sequential)</span>
<span id=t_com>//----------------------------------</span>
<span id=t_kwd>always</span> @ (<span id=t_kwd>posedge</span> <span id=t_idt>clk</span>)
<span id=t_kwd>begin</span> : <span id=t_idt>HCTxArb_CurrentState</span>
  <span id=t_kwd>if</span> (<span id=t_idt>rst</span>) 
   <span id=t_idt>CurrState_HCTxArb</span> &lt;= `<span id=t_idt>START_HARB</span>;
  <span id=t_kwd>else</span>
   <span id=t_idt>CurrState_HCTxArb</span> &lt;= <span id=t_idt>NextState_HCTxArb</span>;
<span id=t_kwd>end</span>

<span id=t_com>//----------------------------------</span>
<span id=t_com>// Registered outputs logic</span>
<span id=t_com>//----------------------------------</span>
<span id=t_kwd>always</span> @ (<span id=t_kwd>posedge</span> <span id=t_idt>clk</span>)
<span id=t_kwd>begin</span> : <span id=t_idt>HCTxArb_RegOutput</span>
  <span id=t_kwd>if</span> (<span id=t_idt>rst</span>) 
  <span id=t_kwd>begin</span>
   <span id=t_idt>muxCntl</span> &lt;= <span id=t_cns>2'b00</span>;
   <span id=t_idt>SOFCntlGnt</span> &lt;= <span id=t_cns>1'b0</span>;
   <span id=t_idt>sendPacketGnt</span> &lt;= <span id=t_cns>1'b0</span>;
   <span id=t_idt>directCntlGnt</span> &lt;= <span id=t_cns>1'b0</span>;
  <span id=t_kwd>end</span>
  <span id=t_kwd>else</span> 
  <span id=t_kwd>begin</span>
   <span id=t_idt>muxCntl</span> &lt;= <span id=t_idt>next_muxCntl</span>;
   <span id=t_idt>SOFCntlGnt</span> &lt;= <span id=t_idt>next_SOFCntlGnt</span>;
   <span id=t_idt>sendPacketGnt</span> &lt;= <span id=t_idt>next_sendPacketGnt</span>;
   <span id=t_idt>directCntlGnt</span> &lt;= <span id=t_idt>next_directCntlGnt</span>;
  <span id=t_kwd>end</span>
<span id=t_kwd>end</span>

<span id=t_kwd>endmodule</span>
</pre>
</body>
</html>
